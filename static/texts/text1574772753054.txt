<h1 style="text-align:start;" size="1" _root="[object Object]" __ownerid="undefined" __hash="undefined" __altered="false"><span style="font-size:28px">Linux使用GitHub钩子实现代码自动部署</span></h1><p></p><div class="media-wrap image-wrap"><img class="media-wrap image-wrap" src="http://localhost:3001/static/images/image.1574761956897.png"/></div><p></p><p>本文章使用 GitHub的webhook，如果使用其他托管仓库，方法都是大同小异。我构建是前端静态页面，框架是React。</p><p></p><p>我的linux已经安装nodejs, npm, pm2，这里不多解释了，直接进入教程。</p><p></p><p>项目存放路径：/home</p><p><span style="color:#c0392b"><strong>Linux安装git</strong></span></p><pre><code>yum install git</code></pre><p><span style="color:#c0392b"><strong>拉取GitHub上项目</strong></span></p><pre><code>git clone [GitHub地址]</code></pre><p><strong><span style="color:#c0392b">创建自动化脚本</span></strong></p><pre><code>touch auto_build.sh</code></pre><p>auto_build.sh 自动化脚本代码</p><pre><code>cd [项目目录]<br/>git pull # 拉取项目代码<br/>npm install # 下载项目依赖<br/>npm run build # 执行项目构建命令<br/>...</code></pre><p><span style="color:#c0392b"><strong>创建nodejs服务器</strong></span></p><pre><code>touch index.js</code></pre><p>index.js脚本代码</p><p>GitHub 使用 git钩子状态插件 是 github-webhook-handler</p><p>以下代码是<a href="https://www.npmjs.com/package/github-webhook-handler" target="_blank">github-webhook-handler的demo</a></p><pre class="editor editor-colors"><code>var http = require(&#x27;http&#x27;)<br/>var createHandler = require(&#x27;github-webhook-handler&#x27;)<br/>// path是我们访问的路径 screct跟github webhooks配置一样<br/>var handler = createHandler({ path: &#x27;/webhook&#x27;, secret: &#x27;myhashsecret&#x27; })<br/> <br/>http.createServer(function (req, res) {<br/>  handler(req, res, function (err) {<br/>    res.statusCode = 404<br/>    res.end(&#x27;no such location&#x27;)<br/>  })<br/>}).listen(7777)<br/> <br/>handler.on(&#x27;error&#x27;, function (err) {<br/>  console.error(&#x27;Error:&#x27;, err.message)<br/>})<br/> <br/>handler.on(&#x27;push&#x27;, function (event) {<br/>  console.log(&#x27;Received a push event for %s to %s&#x27;,<br/>    event.payload.repository.name,<br/>    event.payload.ref)<br/>})<br/> <br/>handler.on(&#x27;issues&#x27;, function (event) {<br/>  console.log(&#x27;Received an issue event for %s action=%s: #%d %s&#x27;,<br/>    event.payload.repository.name,<br/>    event.payload.action,<br/>    event.payload.issue.number,<br/>    event.payload.issue.title)<br/>})</code></pre><p><span style="color:#c0392b"><strong>启动服务器</strong></span></p><p>这里使用pm2启动服务器</p><pre><code>pm2 start index.js</code></pre><p>以上Linux配置已完成</p><p></p><p><span style="color:#c0392b"><strong>GitHub配置</strong></span></p><p>进入GitHub项目</p><p>1.点击settings</p><p>2.点击webhooks</p><p>3.点击add webhook添加</p><div class="media-wrap image-wrap"><img class="media-wrap image-wrap" src="http://localhost:3001/static/images/image.1574849548605.png" width="892px" height="437px" style="width:892px;height:437px"/></div><p></p><p><span style="color:#c0392b"><strong>配置GitHub webhooks选项</strong></span></p><p>1.Payload URL：是否还记得index.js里createHandler的path选项，这里填写[服务器地址+path]</p><p>2.Content type：github-webhookhandler 里说了不支持application/x-www-form-urlencoded，使用application/json</p><p>3.Secret：跟index.js里createHandler的secret选项配置一样</p><div class="media-wrap image-wrap"><img class="media-wrap image-wrap" src="http://localhost:3001/static/images/image.1574849787141.png" width="873px" height="726px" style="width:873px;height:726px"/></div><p>配置基本完成</p><p>展示以下，已经成功</p><div class="media-wrap image-wrap"><img class="media-wrap image-wrap" src="http://localhost:3001/static/images/image.1574850343366.png" width="880px" height="235px" style="width:880px;height:235px"/></div><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p>